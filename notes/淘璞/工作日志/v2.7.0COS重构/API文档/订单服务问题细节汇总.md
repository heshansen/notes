# 订单服务与支付服务注意事项

### 需求大讨论整理

* 购物车按钮(商品详情页和页底快速入口)，查询购物车列表不带特殊条件，除需要验证登录外和老系统保持一致。
* 购物车页，购物车清除按钮不是全部清空，只是批量删除商品；
* 购物车页和结算页中，各门店不展示促销信息，只在最终金额中统一计算；
* 互斥商品(配送方式互斥)，在加入购物车时进行判断，不在结算时处理；
* 特殊商品（门票、预约、定制类）展示需要特殊处理，包括结算页、订单详情页。
* 结算页，增加订单优惠券叠加使用规则接口；重点关注。
* 选择支付页和支付成功页，订单中只有一家门店时，显示门店名称，否则不显示。
* 用户首次注册登录时，需保存默认昵称。
* 已支付取消订单有两种展现方式，全部订单页，按门店展示，在退货/售后页按商品一一呈现，目测需要提供两个列表接口；
* 退货商品列表页，是查询当前子订单所有商品，而不是主订单。
* 申请退货页，图片上传采用新的七牛云存储方式，以前的数据可以全部舍弃，呈现的地方也需要改成七牛云的方式。

### 开发中实际问题

#### 需要对内服务调用

* 商品服务--获取sku商品门店库存信息接口（/product/getProductInfoForWarehouse）
	* 输入参数：brandshopSeq和skuSeq
	* 接口名：需要修改接口命名，这里不仅配单仓用，购物车也会用到；
	* 基本功能：获取商品的基本信息、sku信息以及门店库存信息；
	* 新增字段：商品的提货方式（用于添加购物车前的判断）；商品的淘璞价、快递价、门店价（待定）；

#### 提供对外服务调用

* 根据门店id，查询订单商品评价的平均值和订单评价的平均值，参考OrderCommentServiceImpl中的getCommentPercent()方法中的代码：
// 商品质量评价的平均值
float productAvg = orderItemCommentService.getProductScoreAvg(param);
// 导购服务，门店环境评价的平均值
float levelAndOverallAvg = getLevelAndOverallAvg(param);

#### 2018.3.5 问题集锦

* 确认问题1：购物车排序问题，即”添加购物车已有商品后，购物车中将此门店及商品置顶“。此处变更难点，需单独给”添加已有商品“的接口新增一套排序逻辑。结论，开发非常耗时，没有充裕的时间，建议采用已有的方案：”按创建时间排序，更新购物车已有商品时不作特殊处理“。

* 外部服务接口联调：
	* 需求：通过brandShopSeq和productSeq查询门店是否有促销，用于购物车列表页和结算页相关金额的计算。
	* 期望返回：1.门店基本信息(门店id,门店名称，门店主图)；2.门店促销信息；
	* 老系统参考：PromotionServiceImpl的getModelByProdSeqAndBrandshop方法；

#### 2018.3.6 问题汇总

* 工具类是否要封装成jar包？比如：Emall_Promotions表里entity存的是json字符串，需要将json字符串转list<map>使用，参考老系统的：JsonUtils.java

#### 2018.3.7

* 订单服务-购物车列表接口（优化）：
	* 老系统问题：购物车列表选中商品时，总金额和优惠金额的实时计算是通过前端页面进行的；
	* 新增逻辑：选中/反选商品时，不仅实时更新购物车商品条目信息，还在购物车列表信息返回时实时计算总金额和总优惠金额。
* 需求变更待确认问题：
	* 问题：购物车页和结算页，商品总额和节省总额的计算中，关于”满送“促销方式的促销金额计算问题；
	* 结论：不计算”满送“促销方式的促销金额；

#### 2018.3.8

* 待确认问题：
	* 问题描述：商品详情页立即购买的商品是否需要添加到购物车？
	* 老系统：商品详情页立即购买的商品不添加到购物车。
* 接口联调问题：
	* 调其他服务的接口，必须和服务负责人进行需求对接，否则提供服务接口方容易忘记接口。统一写在对应服务API文档列表后面。
	* 命名“联调接口列表”：必须包含两项内容，输入参数和期望返回数据
* 